from code import interact
from doctest import debug_script
import string
from tokenize import String
import interactions
from discord import app_commands
import numpy
import datetime
from interactions.ext.tasks import IntervalTrigger, create_task

# Date/Time  -----------------------------------------------------------------------

#important! add all dates or fix < and >

def suffix_function(n):
    if n == 1: return "st"
    if n == 2: return "nd"
    if n == 3: return "rd"
    if n >= 4 and n <= 20: return "th"
    if n == 21: return "st"
    if n == 22: return "nd"
    if n == 23: return "rd"
    if n >= 24 and n <= 30: return "th"
    if n == 31: return "st"
   
# BOT SETUP -------------------------------------------------------------------------

bot = interactions.Client(token="MTAyMTUyMzEwNzAzNjUzNjg2Mg.GEWaSl.5tFbNbXZ0EVAuznxoK0KMAgolfMfUVoRZsJ3UU")

print('Daily Discussion Bot started!')

# COMMAND SETUP ---------------------------------------------------------------------

@bot.command(
    name="add_prompt",
    description="Adds a prompt to the backup prompt bank.",
    scope=744023087950987325,
    options = [
        interactions.Option(
            name="prompt",
            description="Your prompt. Do not include date, only the question.",
            type=interactions.OptionType.STRING,
            required=True,
        ),
    ],
    default_member_permissions=interactions.Permissions.MUTE_MEMBERS,  # staff only :)
)
async def add_prompt(ctx: interactions.CommandContext, prompt: string):
    text_file = open('C:/Users/check/Documents/GitHub/Daily-Discussion-Bot/prompt_bank.txt', "a")
    print("Adding prompt - "+prompt)
    await ctx.send("Added prompt: "+prompt)
    text_file.write(prompt+"\n")
    text_file.close

@bot.command(
    name="list_prompts",
    description="Lists all prompts in the bank.",
    scope=744023087950987325,
    default_member_permissions=interactions.Permissions.MUTE_MEMBERS,  # staff only :)
)
async def list_prompts(ctx: interactions.CommandContext):
    promptsFileRead = open('C:/Users/check/Documents/GitHub/Daily-Discussion-Bot/prompt_bank.txt', "r")
    promptArray = promptsFileRead.read().split('\n')
    promptsString = '\n'.join(promptArray)
    await ctx.send(promptsString)


@bot.command(
    name="test_forum_sending",
    description="Test Command - Creates a thread with a discussion question.",
    scope=744023087950987325,
    default_member_permissions=interactions.Permissions.MUTE_MEMBERS,  # staff only :)
)
async def test_forum_sending(ctx: interactions.CommandContext):
    await postForumTopic()
    ctx.send("test successful :)")

async def postForumTopic():
    print("SCHEDULE ACTIVATED!")
    now = datetime.datetime.now()
    datenum = now.strftime('%d')
    dateint = int(datenum)
    print(dateint)
    dateSuffix = suffix_function(dateint)
    dateString = now.strftime('%B %d'+dateSuffix)

    dayConfigFileRead = open('C:/Users/check/Documents/GitHub/Daily-Discussion-Bot/daynum.txt', "r")
    rawDayNum = int(dayConfigFileRead.read())
    dayNum = str(rawDayNum + 1)

    promptsFileRead = open('C:/Users/check/Documents/GitHub/Daily-Discussion-Bot/prompt_bank.txt', "r")
    promptArray = promptsFileRead.read().split('\n')
    todaysQuestion = promptArray[0]

    forumChannel = await interactions.get(bot, interactions.Channel, object_id="1006432594881167470")
    sentMessage = await forumChannel.create_forum_post(dateString,todaysQuestion, applied_tags=[1006433604013932625])
    msgID = sentMessage.id

    staffChannel = await interactions.get(bot, interactions.Channel, object_id="777996362477993984")

    announcementLink = "https://www.discord.com/channels/744023087950987325/"+str(msgID)
    announcementChannel = await interactions.get(bot, interactions.Channel, object_id="766077932686278686")
    await announcementChannel.send("**"+dateString+", "+"Day "+dayNum+", Today's Topic Is: **_"+todaysQuestion+"_"+"\n \nFind the discussion post here:\n"+announcementLink)

    dayConfigFileWrite = open('C:/Users/check/Documents/GitHub/Daily-Discussion-Bot/daynum.txt', "w")
    dayConfigFileWrite.write(dayNum)
    dayConfigFileWrite.close()

    promptsFileWrite = open('C:/Users/check/Documents/GitHub/Daily-Discussion-Bot/prompt_bank.txt', "w")
    promptArray.pop(0)
    print(promptArray)

    if len(promptArray) == 1:
        await staffChannel.send("**NO MORE PROMPTS! If no new prompts are added with /add_prompt, I will not be able to post the daily discussion tomorrow!**")

    promptsString = '\n'.join(promptArray)
    print(promptsString)
    promptsFileWrite.write(promptsString)
    promptsFileWrite.close()

@create_task(IntervalTrigger(86400))
async def dailyTask():
    await postForumTopic()

dailyTask.start()

bot.start()
